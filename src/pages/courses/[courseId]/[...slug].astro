---
import { getCollection, render } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';

export async function getStaticPaths() {
	const courses = await getCollection('courses');
	const library = await getCollection('library');

	return courses.flatMap((course) => {
		const courseLOs = library.filter((entry) => {
			const [folder, unitName] = entry.id.split('/');
			const isCorrectLevel = folder === course.data.levelId;
			const isCorrectUnit = course.data.units.includes(entry.data.unit);
			return isCorrectLevel && isCorrectUnit;
		});

		courseLOs.sort((a, b) => a.data.order - b.data.order);

		const routes = courseLOs.map((lo) => {
			const cleanSlug = lo.id.replace(`${course.data.levelId}/`, '');
			return {
				params: { courseId: course.id, slug: cleanSlug },
				props: { course, lo, courseLOs },
			};
		});

		if (courseLOs.length > 0) {
			routes.push({
				params: { courseId: course.id, slug: undefined },
				props: { course, lo: courseLOs[0], courseLOs },
			});
		}

		return routes;
	});
}

const { course, lo, courseLOs } = Astro.props;
const { Content } = await render(lo);

const unitsMap = courseLOs.reduce((acc, entry) => {
	const unitKey = entry.data.unit;
	if (!acc[unitKey]) acc[unitKey] = [];
	acc[unitKey].push(entry);
	return acc;
}, {});
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${lo.data.title} - ${course.data.title}`} description={course.data.description} />
		<style>
			.course-container {
				display: grid;
				grid-template-columns: 280px 1fr 300px;
				gap: 2rem;
				width: 100%;
				max-width: 100%; 
				padding: 2rem;
				box-sizing: border-box;
				min-height: 80vh;
			}

			/* SIDEBAR STYLES UPDATED */
			aside.nav-sidebar {
				background: var(--bg-sidebar); /* UPDATED */
				padding: 1.5rem;
				border-radius: 8px;
				height: fit-content;
				position: sticky;
				top: 2rem;
				border: 1px solid var(--border-color); /* Added border for better contrast */
			}

			main.content-area {
				max-width: 900px; 
				margin: 0 auto; 
				width: 100%;
			}

			aside.ad-sidebar {
				height: 100%;
			}
			
			.ad-container {
				position: sticky;
				top: 2rem;
				width: 100%;
				min-height: 600px;
				/* UPDATED AD CONTAINER COLORS */
				background-color: var(--bg-sidebar); 
				border: 1px dashed var(--border-color);
				display: flex;
				align-items: center;
				justify-content: center;
				text-align: center;
				color: var(--gray);
				border-radius: 8px;
			}

			details { margin-bottom: 0.5rem; }
			
			summary {
				cursor: pointer;
				font-weight: bold;
				padding: 0.5rem;
				list-style: none;
				background-color: var(--bg-card); /* UPDATED */
				border: 1px solid var(--border-color); /* UPDATED */
				border-radius: 4px;
				color: var(--text-main); /* UPDATED */
			}
			
			summary::-webkit-details-marker { display: none; }
			summary::after { content: "+"; float: right; }
			details[open] summary::after { content: "-"; }
			
			.lo-list {
				margin-top: 0.5rem;
				display: flex;
				flex-direction: column;
				gap: 0.25rem;
			}
			
			.lo-link {
				text-decoration: none;
				color: var(--text-main); /* UPDATED */
				padding: 0.4rem 0.4rem 0.4rem 1rem;
				font-size: 0.95rem;
				border-left: 3px solid transparent;
				transition: background-color 0.2s;
			}
			
			.lo-link:hover { 
				color: var(--accent); 
				background: var(--bg-hover); /* UPDATED */
			}
			
			.lo-link.active {
				border-left-color: var(--accent);
				color: var(--accent);
				font-weight: bold;
				background: var(--bg-active); /* UPDATED */
			}
			
			.unit-badge { 
				font-size: 0.8em; 
				color: var(--gray); /* UPDATED */
				margin-bottom: 0.5rem; 
				display: block; 
				text-transform: uppercase; 
				letter-spacing: 1px;
				font-weight: bold;
			}

			@media (max-width: 1100px) {
				.course-container { 
					grid-template-columns: 1fr; 
					padding: 1rem;
				}
				aside.nav-sidebar, aside.ad-sidebar, main.content-area {
					max-width: 100%;
					width: 100%;
				}
				aside.ad-sidebar {
					order: 3;
					display: flex;
					justify-content: center;
				}
				.ad-container {
					min-height: 250px;
					width: 300px;
				}
			}
		</style>
	</head>
	<body>
        <Header 
            courseTitle={course.data.title} 
            courseLevel={course.data.levelId.toUpperCase()} 
        />

		<div class="course-container">
            
			<aside class="nav-sidebar">
                {Object.entries(unitsMap).map(([unitName, los]) => (
					<details open={lo.data.unit === unitName}>
						<summary>{unitName.replace(/-/g, ' ').toUpperCase()}</summary>
						<div class="lo-list">
							{los.map((entry) => {
								const cleanSlug = entry.id.replace(`${course.data.levelId}/`, '');
								return (
									<a 
										href={`/courses/${course.id}/${cleanSlug}`}
										class={`lo-link ${lo.id === entry.id ? 'active' : ''}`}
									>
										{entry.data.title}
									</a>
								);
							})}
						</div>
					</details>
				))}
			</aside>
			
			<main class="content-area">
                <span class="unit-badge">
                    {course.data.levelId} / {lo.data.unit}
                </span>
				<h1>{lo.data.title}</h1>
				<hr />
				<Content />
			</main>

            <aside class="ad-sidebar">
                <div class="ad-container">
                    <p>Google Ad Banner<br/>(Vertical)</p>
                </div>
            </aside>

		</div>
		<Footer />
	</body>
</html>